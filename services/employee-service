var roleService = require('./role-service');
var async = require('async');

function EmployeeService() {
    // see prototype functions
}

EmployeeService.prototype.getEmployee = function (firebase, bot, message) {
    var getEmployee = function(response, convo) {
        var userName = response.text;
        var dbEmployeeRef = firebase.database().ref("employees/" + userName);
        dbEmployeeRef.once('value', function(snapshot) {
            if (snapshot.val()) {
                convo.say("We do have an employee with the user name " + snapshot.key);
                getEmployeeRoles(firebase, userName);
                convo.next();
            } else {
                convo.say('Sorry, I don\'t know any employees by that username.');
                convo.next();
            }
        })
    };

    var whoToLookUp = function (error, convo) {
        if (!error) {
            convo.ask('Who do you want to know about?', function (response, convo) {
                getEmployee(response, convo);
                convo.next();
            });
        }
    };

    bot.startConversation(message, whoToLookUp);
};

EmployeeService.prototype.findAnEmployee = function (firebase, bot, message) {
    var findEmployee = function(response, convo) {
        var theRole = response.text;
        var theEmployees = [];

        async.waterfall([
            function(callback) {
                getEmployees(firebase, callback);
            },
            function(employees, callback) {
                theEmployees = employees;

                // loop through employees and get roles
                async.eachSeries(theEmployees, function(employee, innerCallback) {
                    getEmployeeRoles(firebase, employee, function(err, results) {
                        if (err) {
                            return innerCallback(err);
                        }
                        // loop through employee roles
                        for (var x = 0; x < results.length; x++) {
                            // if it is the role i'm looking for, return the employee with role
                            if (theRole == results[x]) {
                                return callback(null, employee);
                            }
                        }
                        innerCallback(null);
                    });
                },callback);
            }
        ], function (err, employee) {
            if (err) {
                console.log("something went wrong");
            }

            bot.startConversation(message, function(err, convo) {
                convo.say(employee + " knows a lot about " + theRole);
            });
        });
    };

    var whatToLookUp = function (error, convo) {
        if (!error) {
            convo.ask('What role do you want to know about?', function (response, convo) {
                findEmployee(response, convo);
                convo.next();
            });
        }
    };

    bot.startConversation(message, whatToLookUp);
};

function getEmployeeRoles (firebase, userName, done) {
    var roles = [];
    var dbRef = firebase.database().ref("employees/" + userName + "/roles");
    dbRef.once("value").then(function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
            roles.push(childSnapshot.key);
        });
        done(null, roles);
    });
};

function getEmployees (firebase, done) {
    var employees = [];
    var dbRef = firebase.database().ref("employees").orderByKey();
    dbRef.once("value").then(function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
            employees.push(childSnapshot.key)
        });
        done(null, employees);
    });
};

module.exports = new EmployeeService();